generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(STUDENT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student?

  @@map("users")
}

model Student {
  id        String      @id @default(cuid())
  userId    String      @unique
  studentId String      @unique
  firstName String
  lastName  String
  classId   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  attempts  Attempt[]
  class     SchoolClass @relation(fields: [classId], references: [id])
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("students")
}

model SchoolClass {
  id            String         @id @default(cuid())
  name          String
  stream        String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  assessments   Assessment[]
  classSubjects ClassSubject[]
  students      Student[]

  @@unique([name, stream])
  @@map("school_classes")
}

model Subject {
  id            String         @id @default(cuid())
  name          String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  assessments   Assessment[]
  classSubjects ClassSubject[]

  @@map("subjects")
}

model ClassSubject {
  id        String      @id @default(cuid())
  classId   String
  subjectId String
  createdAt DateTime    @default(now())
  class     SchoolClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject   Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId])
  @@map("class_subjects")
}

model Assessment {
  id           String           @id @default(cuid())
  title        String
  description  String?
  subjectId    String
  classId      String
  duration     Int
  totalMarks   Int              @default(0)
  passMarks    Int              @default(0)
  status       AssessmentStatus @default(DRAFT)
  showResults  Boolean          @default(false)
  startTime    DateTime?
  endTime      DateTime?
  instructions String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  class        SchoolClass      @relation(fields: [classId], references: [id])
  subject      Subject          @relation(fields: [subjectId], references: [id])
  attempts     Attempt[]
  questions    Question[]

  @@map("assessments")
}

model Question {
  id            String       @id @default(cuid())
  assessmentId  String
  questionText  String
  questionType  QuestionType
  options       Json?
  correctAnswer String
  marks         Int          @default(1)
  explanation   String?
  orderIndex    Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  answers       Answer[]
  assessment    Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model Attempt {
  id           String        @id @default(cuid())
  studentId    String
  assessmentId String
  startedAt    DateTime      @default(now())
  submittedAt  DateTime?
  status       AttemptStatus @default(IN_PROGRESS)
  totalScore   Int           @default(0)
  percentage   Float         @default(0.0)
  timeSpent    Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  answers      Answer[]
  assessment   Assessment    @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, assessmentId])
  @@map("attempts")
}

model Answer {
  id           String   @id @default(cuid())
  attemptId    String
  questionId   String
  answer       String
  isCorrect    Boolean  @default(false)
  marksAwarded Int      @default(0)
  createdAt    DateTime @default(now())
  attempt      Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question     Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("answers")
}

enum UserRole {
  ADMIN
  STUDENT
}

enum AssessmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_BLANK
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  TIMED_OUT
}
